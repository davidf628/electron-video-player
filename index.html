<!DOCTYPE html>
<html>
    
<head>

    <meta charset="UTF-8">
    <link type="text/css" rel="stylesheet" href="./node_modules/video.js/dist/video-js.min.css" />
    <script src="./js/d3.js"></script>
    <script src="./js/misc.js"></script>
    <title>MATH 104 Video Player</title>

    <style>
        .center {
            padding: 100px 50px;
            border: 3px solid green;
            text-align: center;
        }
    </style>

</head>

<body>


<!-- This is the code for the login information interface -->

<div id="login" class="center">

    <p>Enter Login Information</p>
    <input type="input" placeholder="Name (First and Last)" />
    <input type="input" placeholder="StudentID" />
    <br/><br/>
    <input type="button" value="Create New Video Database" onclick="showVideoTab()">
    <br/><br/>
    <input type="button" value="Open Existing Video Database" onclick="showVideoTab()">

</div>

  
<!-- This is the code for the video playback inteface -->

<div id="video">
    <input type="button" value="Play Video" onclick="player.play()" />
    <video
        id="vid1"
        class="video-js vjs-default-skin"
        controls
        preload='auto'
        width="640" height="480"

        data-setup='{ 
            "muted": true, 
            "controls": false,
            "techOrder": ["youtube", "html5"], 
            "sources": [
                { "type": "video/youtube", "src": "https://youtu.be/DNQOjVkixqI"}], 
            "youtube": { "ytControls": 2 }  }'
      ></video>

      <script src="./node_modules/video.js/dist/video.js"></script>
      <script src="./dist/Youtube.js"></script>

      <input type="button" value="Save Video" onclick="saveVideo(intervalsWatched)" />

      <div id="status-bar">
          <svg id="status-background">

          </svg>
      </div>
</div>


<script>

  function saveVideo(intervals_watched) {
    const data = {
        video_id: 'DNQOjVkixqI',
        student_name: 'David Flenner',
        student_id: '20125179',
        score: getPercentViewed(intervals_watched, player.duration()),
        intervals_watched: intervals_watched,
        timestamp: new Date()
    }
    console.log(data);
    window.api.saveVideo(data);
}

window.api.handleEditorEvent( (event, cmd) => {
  switch(cmd.action) {
      case 'set-version':
          window.document.title = `Version: ${cmd.data}`;
          break;
      case 'set-directory':
          document.getElementById("svg-path").innerText = cmd.data;
          break;
      default:
          break;    
  };
});


async function setVersion() {

  let version = await window.api.getVersion();
  window.document.title = `MATH 104 Video Player v${version}`;
}
  
setVersion();

  window.api.receive('toMain', (data) => {
    console.log(`Received ${data} from main process.`);
  });

  window.api.receive('get-version', (version) => {
    console.log('change title');
    window.document.title = `MATH 104 Video Player v${version}`;
  });

  window.document.title = 'hi';

    function showVideoTab() {
      document.getElementById('login').style.display = 'none';
      document.getElementById('video').style.display = 'block';
    }

    document.getElementById('video').style.display = 'none';
    player = videojs('vid1');
    player.fluid(true);
    player.bigPlayButton.show();

    player.ready(() => {

      xScale.domain([0, player.duration()]);

      myTimer = setInterval(
        function () { 
          intervalsWatched = addToPlayedIntervals(player.currentTime(), intervalsWatched);
          drawProgress(intervalsWatched); 
        }, 
      1000);

    });

    intervalsWatched = [];

    function drawProgress(intervals_watched) {

      let percent = `${getPercentViewed(intervals_watched, player.duration())}%`;
 
      d3.select('#chart-area').remove();
      let chart_area = d3.select('#status-background')
        .append('g')
        .attr('id', 'chart-area')
      if (!isNaN(xScale(0))) {
        chart_area.selectAll("rect")
          .data(intervals_watched)
          .enter()
          .append("rect")
          .attr("x", (d, i) => { return xScale(d[0]); })
          .attr("y", 0)
          .attr("width", (d) => { return xScale(d[1] - d[0]); })
          .attr("height", 50)
          .attr("fill", "blue")
          .attr("stroke", "black");
        chart_area
          .append('text')
          .style('font-family', 'Helvetica')
          .style('font-size', 40)
          .style('font-weight', 'bold')
          .attr('fill', 'white')
          .attr('transform', `translate(300,27)`)
          .attr('text-anchor', 'middle')
          .attr('dominant-baseline', 'middle')
          .text(percent);
      } else {
        xScale.domain([0, player.duration()]);
      }
    }

    function changeVideo() {
     // "sources": [{ "type": "video/youtube", "src": "https://youtu.be/DwnLK_gbHuI"}]
      player.src({ type: 'video/youtube', src: 'https://youtu.be/DwnLK_gbHuI' })
    }

    let svg = d3.select('#status-background')
      .attr('width', 600)
      .attr('height', 50);

    setBackground(svg, 600, 50, "lightgray", "black");

    svg
      .append('g')
      .attr('id', 'chart-area');

    let xScale = d3.scaleLinear().range([0, 600]);


  </script>


</body>

</html>