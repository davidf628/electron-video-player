<!DOCTYPE html>
<html>
    
<head>
    <meta charset="UTF-8">
   <!-- <link type="text/css" rel="stylesheet" href="./node_modules/video.js/dist/video-js.min.css" /> -->
    <link href="https://vjs.zencdn.net/8.5.2/video-js.css" rel="stylesheet" />
    <script src="./js/d3.js"></script>
    <script src="./js/misc.js"></script>
    <title>MATH 104 Video Player</title>

    <style>
        .center {
            padding: 100px 50px;
            border: 3px solid green;
            text-align: center;
        }
    </style>

</head>

<body>


<!-- This is the code for the login information interface -->

<div id="login" class="center">

    <p>Enter Login Information</p>
    <input id="username" type="input" placeholder="Name (First and Last)" />
    <input id="studentid" type="input" placeholder="StudentID" />
    <br/><br/>
    <p id="video-file"></p>
    <input type="button" value="Use Current File" onclick="startProgram()" />
    <br/><br/>
    <input type="button" value="New Video Database" onclick="createNewDatabase()" />
    <input type="button" value="Open Video Database" onclick="openVideoDatabase()" />

</div>

  
<!-- This is the code for the video playback inteface -->

<div id="video">
    
    <h2 id="video-title">1-1 Lecture</h2>

    <video
        id="vid1"
        class="video-js vjs-default-skin"
        controls
        preload='auto'
        width="640" height="480"

        data-setup='{ 
            "muted": false, 
            "controls": false,
            "techOrder": ["youtube", "html5"], 
            "sources": [
                { "type": "video/youtube", "src": "https://youtu.be/pKdi1Kz0eJU"}], 
            "youtube": { "ytControls": 2 }  }'
    ></video>

    <script src="https://vjs.zencdn.net/8.5.2/video.min.js"></script>
    <!--<script src="./node_modules/video.js/dist/video.js"></script>-->
    <!--<script src="https://cdnjs.cloudflare.com/ajax/libs/videojs-youtube/3.0.1/Youtube.js"></script>-->

    <script src="./dist/Youtube.js"></script> 
    
    <br/><br/>

    <input type="button" value="Play Video" onclick="playCurrentVideo()" />&emsp;&emsp;
    <input type="button" value="Save Video" onclick="saveVideo(currentVideo, intervalsWatched)" />&emsp;&emsp;

    <label for="module-select">Module:</label>
    <select id="module-select" onchange="changeModule()">
        <option value="item1">Item 1</option>
        <option value="item2">Item 2</option>
        <option value="item3">Item 3</option>
        <option value="item4">Item 4</option>
    </select>&emsp;&emsp;

    <label for="lesson-select">Lesson:</label>
    <select id="lesson-select" onchange="changeLesson()">
        <option value="item1">Item 1</option>
        <option value="item2">Item 2</option>
        <option value="item3">Item 3</option>
        <option value="item4">Item 4</option>
    </select>&emsp;&emsp;

    <label for="video-select">Video:</label>
    <select id="video-select" onchange="changeVideo(true)">
        <option value="item1">Item 1</option>
        <option value="item2">Item 2</option>
        <option value="item3">Item 3</option>
        <option value="item4">Item 4</option>
    </select>

    <br/><br/>

    <div id="status-bar">
        <svg id="status-background">

        </svg>
    </div>
</div>


<!-- Setup code and underlying functionality -->

<script>

    // -------- Setup code ---------

    // Preserve the current video loaded in the player
    currentVideo = 'pKdi1Kz0eJU';
    currentModule = 1;
    currentLesson = 1;

    // Set the window title to contain the current version number
    setVersion();

    // Retrieve the current list of videos playable on YouTube
    setVideoOptions();

    // Retrieve the current username, id, and data file on record
    getDefaultSettings();

    // Hide the video display panel initially 
    document.getElementById('video').style.display = 'none';

    // Set up the svg area for drawing the status bar
    let xScale = d3.scaleLinear().range([0, 600]);

    let svg = d3.select('#status-background')
        .attr('width', 600)
        .attr('height', 50);

    setBackground(svg, 600, 50, "lightgray", "black");

    svg
        .append('g')
        .attr('id', 'chart-area');

    // Setup the player
    intervalsWatched = [];
    video_data = [];

    player = videojs('vid1');
    player.fluid(true);

    player.ready(() => {
        xScale.domain([0, player.duration()]);

        myTimer = setInterval(
            function () { 
                intervalsWatched = addToPlayedIntervals(player.currentTime(), intervalsWatched);
                drawProgress(intervalsWatched); 
            }, 1000);
    });

window.api.invokeSaveAction( (event) => {
    saveVideo(currentVideo, intervalsWatched);
});

/******************************************************************************
 * The entry point for the main video interface
 */
function startProgram() {

    // send username, student id, and video file back to main program
    let student_name = document.getElementById('username').value;
    let student_id = document.getElementById('studentid').value;
    window.api.setUserData(student_name, student_id);

    // Check to see if a .vdb file has been created and is active
    window.api.getDefaultSettings()
        .then((prefs) => {
            if (prefs.data_file !== '') {
                showVideoTab();
            } else {
                window.api.showMessageDialog('Error', 'You first have to create or open a video database file to begin.');
            }
        });

    

}


/******************************************************************************
 * Opens a save file dialog and allows the use to create a new file for saving
 *  video results.
 */

function createNewDatabase() {
    window.api.createNewFile();
    window.api.getDefaultSettings()
        .then((prefs) => {
            document.getElementById('video-file').innerHTML = prefs.data_file;
        });
}


/******************************************************************************
 * Opens a dialog that allows the user to choose a video database file that
 *  exists already and load it into memory.
 */

 function openVideoDatabase() {
    window.api.openExistingFile();
    window.api.getDefaultSettings()
        .then((prefs) => {
            document.getElementById('video-file').innerHTML = prefs.data_file;
        });
 }

/*****************************************************************************
 * Call the backend to find out what the current version of the program is
 *  and display that in the window title.
 */

async function setVersion() {
    let version = await window.api.getVersion();
    window.document.title = `MATH 104 Video Player v${version}`;
}


/******************************************************************************
 * Call the backend to get the default settings of username, studentID, and 
 *  data file saved in the user preferences and load them if they exist
 */
function getDefaultSettings() {
    window.api.getDefaultSettings()
        .then((prefs) => {
            document.getElementById('username').value = prefs.user_name;
            document.getElementById('studentid').value = prefs.student_id;
            document.getElementById('video-file').innerHTML = prefs.data_file;
        });
}

/******************************************************************************
 * Get a list of all the current videos that can be played, and places them 
 *  into a select box so the user can change videos. 
 */

async function setVideoOptions() {
    let buffer = await window.api.get_video_data();
    video_data = buffer;

    let module_list = [];
    let lesson_list = [];
    let video_list = [];

    // Get a list of all videos in the currently selected 
    for (let video of video_data) {

        if (!module_list.includes(video.module)) {
            module_list.push(video.module);
        }

        if ((video.module == currentModule) && !lesson_list.includes(video.lesson)) {
            lesson_list.push(video.lesson);
        }

        if ((video.module == currentModule) && (video.lesson == currentLesson)) {
            video_list.push(video);
        }
    }

    // Add Module Options
    let module_select = document.getElementById('module-select');
    while (module_select.length > 0) {
        module_select.remove(0);
    }
    for (let module of module_list) {
        let option = document.createElement('option');
        option.text = `Module ${module}`;
        option.value = module;
        module_select.add(option, null);
    }

    // Add Lesson Options
    let lesson_select = document.getElementById('lesson-select');
    while (lesson_select.length > 0) {
        lesson_select.remove(0);
    }
    for (let lesson of lesson_list) {
        let option = document.createElement('option');
        option.text = `Lesson ${lesson}`;
        option.value = lesson;
        lesson_select.add(option, null);
    }

    // get reference to video list
    let video_select = document.getElementById('video-select');

    // remove current video options
    while (video_select.length > 0) {
        video_select.remove(0);
    }

    // add the YouTube video links
    for (let video of video_list) {
        let option = document.createElement('option');
        option.text = video.name;
        option.value = video.youtube_id;
        video_select.add(option, null);
    }

}

function changeModule() {

    currentModule = document.getElementById('module-select').value;
    
    // By default, choose lesson 1 when a new module is selected
    currentLesson = 1;

    let lesson_list = [];
    let video_list = [];

    // Get a list of all the  
    for (let video of video_data) {

        // Get a list of all the lessons in the newly selected module
        if ((video.module == currentModule) && !lesson_list.includes(video.lesson)) {
            lesson_list.push(video.lesson);
        }

        // Get a list of all the videos in the newly selected module (lesson 1)
        if ((video.module == currentModule) && (video.lesson == currentLesson)) {
            video_list.push(video);
        }
    }

    // Add Lesson Options
    let lesson_select = document.getElementById('lesson-select');
    while (lesson_select.length > 0) {
        lesson_select.remove(0);
    }
    for (let lesson of lesson_list) {
        let option = document.createElement('option');
        option.text = `Lesson ${lesson}`;
        option.value = lesson;
        lesson_select.add(option, null);
    }

    // get reference to video list
    let video_select = document.getElementById('video-select');

    // remove current video options
    while (video_select.length > 0) {
        video_select.remove(0);
    }

    // add the YouTube video links
    for (let video of video_list) {
        let option = document.createElement('option');
        option.text = video.name;
        option.value = video.youtube_id;
        video_select.add(option, null);
    }

    changeVideo(true);
}

function changeLesson() {

    let currentLesson = document.getElementById('lesson-select').value;

    let video_list = [];

    for (let video of video_data) {

        // Get a list of all the videos in the newly selected module (lesson 1)
        if ((video.module == currentModule) && (video.lesson == currentLesson)) {
            video_list.push(video);
        }
    }

    // get reference to video list
    let video_select = document.getElementById('video-select');

    // remove current video options
    while (video_select.length > 0) {
        video_select.remove(0);
    }

    // add the YouTube video links
    for (let video of video_list) {
        let option = document.createElement('option');
        option.text = video.name;
        option.value = video.youtube_id;
        video_select.add(option, null);
    }

    changeVideo(true);
}

    /**************************************************************************
     * Sends the current view data to the backend in order to save the
     *  current view information to disk.
     */

     function saveVideo(id, intervals_watched) {
        let title = get_video_title(id);
        let user = document.getElementById('username').value;
        let studentid = document.getElementById('studentid').value;
        const data = {
            video_id: id,
            video_title: title,
            student_name: user,
            student_id: studentid,
            score: getPercentViewed(intervals_watched, player.duration()),
            intervals_watched: intervals_watched,
            timestamp: new Date()
        }
        window.api.saveVideo(data);
    }

    /**************************************************************************
     * Switches the interface between the retrieve username/student id to the
     *  video player interface
     */

    function showVideoTab() {
        document.getElementById('login').style.display = 'none';
        document.getElementById('video').style.display = 'block';
    }

    /**************************************************************************
     * Uses D3 to draw the progress bar based on the intervals that have
     *  already been watched.
     */

    function drawProgress(intervals_watched) {

        let percent = `${getPercentViewed(intervals_watched, player.duration())}%`;
        
        d3.select('#chart-area').remove();
        let chart_area = d3.select('#status-background')
            .append('g')
            .attr('id', 'chart-area')
        
        if (!isNaN(xScale(0))) {
            chart_area.selectAll("rect")
                .data(intervals_watched)
                .enter()
                .append("rect")
                .attr("x", (d, i) => { return xScale(d[0]); })
                .attr("y", 0)
                .attr("width", (d) => { return xScale(d[1] - d[0]); })
                .attr("height", 50)
                .attr("fill", "blue")
                .attr("stroke", "black");
            chart_area
                .append('text')
                .style('font-family', 'Helvetica')
                .style('font-size', 40)
                .style('font-weight', 'bold')
                .attr('fill', 'white')
                .attr('transform', `translate(300,27)`)
                .attr('text-anchor', 'middle')
                .attr('dominant-baseline', 'middle')
                .text(percent);
        } else {
            xScale.domain([0, player.duration()]);
        }
    }

    /**************************************************************************
     * Changes the current video loaded into the player
     */

    function changeVideo(play) {

        saveVideo(currentVideo, intervalsWatched);
        intervalsWatched = [];

        let video = document.getElementById('video-select').value;
        let length = get_video_length(video);
        let title = get_video_title(video);
        currentVideo = video;

        if (length === null) {
            length = player.duration();
        }

        // Change video title display:
        document.getElementById('video-title').innerHTML = title;

        window.api.getIntervalsWatched(video)
            .then(view => { intervalsWatched = view; });
        
        player.src({ type: 'video/youtube', src: `https://youtu.be/${video}` });

        xScale = d3.scaleLinear()
            .domain([0, length])
            .range([0, 600]);

        if (play) {
            player.play();
        }

    }

    function playCurrentVideo() {
       intervalsWatched = [];
       let video = document.getElementById('video-select').value;
       window.api.getIntervalsWatched(video)
            .then(view => { intervalsWatched = view; }); 
        player.play();
    }

    function get_video_length(video_to_find) {
        for (let video of video_data) {
            if (video.youtube_id === video_to_find) {
                let [min, sec] = video.length.split(':');
                let len = parseInt(min) * 60 + parseInt(sec);
                return len;
            }
        }
        return null;
    }

    function get_video_title(video_to_find) {
        for (let video of video_data) {
            if (video.youtube_id === video_to_find) {
                return video.name;
            }
        }
        return null;
    }

</script>

</body>

</html>