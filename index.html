<!DOCTYPE html>
<html>
    
<head>
    <meta charset="UTF-8">
    <link type="text/css" rel="stylesheet" href="./node_modules/video.js/dist/video-js.min.css" />
    <script src="./js/d3.js"></script>
    <script src="./js/misc.js"></script>
    <title>MATH 104 Video Player</title>

    <style>
        .center {
            padding: 100px 50px;
            border: 3px solid green;
            text-align: center;
        }
    </style>

</head>

<body>


<!-- This is the code for the login information interface -->

<div id="login" class="center">

    <p>Enter Login Information</p>
    <input id="username" type="input" placeholder="Name (First and Last)" />
    <input id="studentid" type="input" placeholder="StudentID" />
    <br/><br/>
    <input type="button" value="Create New Video Database" onclick="showVideoTab()">
    <br/><br/>
    <input type="button" value="Open Existing Video Database" onclick="showVideoTab()">

</div>

  
<!-- This is the code for the video playback inteface -->

<div id="video">
    <input type="button" value="Play Video" onclick="player.play()" />
    <video
        id="vid1"
        class="video-js vjs-default-skin"
        controls
        preload='auto'
        width="640" height="480"

        data-setup='{ 
            "muted": true, 
            "controls": false,
            "techOrder": ["youtube", "html5"], 
            "sources": [
                { "type": "video/youtube", "src": "https://youtu.be/NAUcEM98xqs"}], 
            "youtube": { "ytControls": 2 }  }'
      ></video>

      <script src="./node_modules/video.js/dist/video.js"></script>
      <script src="./dist/Youtube.js"></script>

      <input type="button" value="Save Video" onclick="saveVideo(intervalsWatched)" />

      <label for="video-select">Select a video:</label>

      <select id="video-select" onchange="changeVideo(this, true)">
        <option value="item1">Item 1</option>
        <option value="item2">Item 2</option>
        <option value="item3">Item 3</option>
        <option value="item4">Item 4</option>
      </select> 

      <div id="status-bar">
          <svg id="status-background">

          </svg>
      </div>
</div>


<!-- Setup code and underlying functionality -->

<script>

    // -------- Setup code ---------

    // Set the window title to contain the current version number
    setVersion();

    // Retrieve the current list of videos playable on YouTube
    setVideoOptions();

    // Hide the video display panel initially 
    document.getElementById('video').style.display = 'none';

    // Set up the svg area for drawing the status bar
    let xScale = d3.scaleLinear().range([0, 600]);

    let svg = d3.select('#status-background')
        .attr('width', 600)
        .attr('height', 50);

    setBackground(svg, 600, 50, "lightgray", "black");

    svg
        .append('g')
        .attr('id', 'chart-area');

    // Setup the player
    intervalsWatched = [];

    player = videojs('vid1');
    player.fluid(true);

    player.ready(() => {
        xScale.domain([0, player.duration()]);

        myTimer = setInterval(
            function () { 
                intervalsWatched = addToPlayedIntervals(player.currentTime(), intervalsWatched);
                drawProgress(intervalsWatched); 
            }, 1000);
    });

    


window.api.handleEditorEvent( (event, cmd) => {
    switch(cmd.action) {
        case 'set-version':
            window.document.title = `Version: ${cmd.data}`;
            break;
        case 'set-directory':
            document.getElementById("svg-path").innerText = cmd.data;
            break;
        default:
            break;    
    };
});

    /*****************************************************************************
     * Call the backend to find out what the current version of the program is
     *  and display that in the window title.
     */

    async function setVersion() {
        let version = await window.api.getVersion();
        window.document.title = `MATH 104 Video Player v${version}`;
    }
    
    /******************************************************************************
     * Get a list of all the current videos that can be played, and places them 
     *  into a select box so the user can change videos. 
     */

    async function setVideoOptions() {
        let video_data = await window.api.get_video_data();

        // get reference to video list
        let video_select = document.getElementById('video-select');

        // remove current video options
        while (video_select.length > 0) {
            video_select.remove(0);
        }

        // add the YouTube video links
        for (let video in video_data) {
            let option = document.createElement('option');
            option.text = video_data[video].title;
            option.value = video_data[video].id;
            video_select.add(option, null);
        }

    }


    /**************************************************************************
     * Sends the current view data to the backend in order to save the
     *  current view information to disk.
     */

     function saveVideo(intervals_watched) {
        let id = document.getElementById('video-select').value;
        let user = document.getElementById('username').value;
        let studentid = document.getElementById('studentid').value;
        const data = {
            video_id: id,
            student_name: user,
            student_id: studentid,
            score: getPercentViewed(intervals_watched, player.duration()),
            intervals_watched: intervals_watched,
            timestamp: new Date()
        }
        window.api.saveVideo(data);
    }

    /**************************************************************************
     * Switches the interface between the retrieve username/student id to the
     *  video player interface
     */

    function showVideoTab() {
        document.getElementById('login').style.display = 'none';
        document.getElementById('video').style.display = 'block';
    }

    /**************************************************************************
     * Uses D3 to draw the progress bar based on the intervals that have
     *  already been watched.
     */

    function drawProgress(intervals_watched) {

        let percent = `${getPercentViewed(intervals_watched, player.duration())}%`;
        
        d3.select('#chart-area').remove();
        let chart_area = d3.select('#status-background')
            .append('g')
            .attr('id', 'chart-area')
        
        if (!isNaN(xScale(0))) {
            chart_area.selectAll("rect")
                .data(intervals_watched)
                .enter()
                .append("rect")
                .attr("x", (d, i) => { return xScale(d[0]); })
                .attr("y", 0)
                .attr("width", (d) => { return xScale(d[1] - d[0]); })
                .attr("height", 50)
                .attr("fill", "blue")
                .attr("stroke", "black");
            chart_area
                .append('text')
                .style('font-family', 'Helvetica')
                .style('font-size', 40)
                .style('font-weight', 'bold')
                .attr('fill', 'white')
                .attr('transform', `translate(300,27)`)
                .attr('text-anchor', 'middle')
                .attr('dominant-baseline', 'middle')
                .text(percent);
        } else {
                xScale.domain([0, player.duration()]);
        }
    }

    /**************************************************************************
     * Changes the current video loaded into the player
     */

    function changeVideo(play) {
        let video = document.getElementById('video-select').value;

        window.api.getIntervalsWatched(video)
            .then(view => { console.log(view); intervalsWatched = view; })
        
        player.src({ type: 'video/youtube', src: `https://youtu.be/${video}` });
        if (play) {
            player.play();
        }

    }

</script>

</body>

</html>